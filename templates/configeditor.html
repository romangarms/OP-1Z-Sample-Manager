{% extends "base.html" %}
{% from 'macros.html' import nav_button %}

{%block stylesheets %}
<link rel="stylesheet" href="/static/css/configeditor.css">
{%endblock%}

{%block title %}
<title>OP-Z Config Editor</title>
{%endblock%}

{% block main %}
<h1>OP-Z Config Editor</h1>

<div class="header-row">
    {{ nav_button('/', 'Home', icon='home') }}
    <div id="config-tabs-container"></div>
</div>

<div id="device-error-container" class="error-container container" hidden>
    <p id="device-error-message">OP-Z not configured. Please configure your OP-Z in <a href="/utilitysettings" class="btn btn-danger">Utility Settings</a></p>
</div>

<div id="main-content">
    <div id="config-container">
        <!-- General Tab Content -->
        <div id="tab-general" class="tab-content">
            <div class="config-section">
                <form id="general-form" class="config-form-inner"></form>
            </div>
        </div>

        <!-- MIDI Tab Content -->
        <div id="tab-midi" class="tab-content" hidden>
            <div class="config-section">
                <!-- Global MIDI Settings -->
                <div id="midi-global-settings" class="midi-global-section">
                    <h3>Global MIDI Settings</h3>
                    <form id="midi-global-form" class="config-form-inner"></form>
                </div>

                <!-- Track Sections (Accordions) -->
                <div id="midi-track-sections" class="track-accordions"></div>
            </div>
        </div>

        <!-- DMX Tab Content -->
        <div id="tab-dmx" class="tab-content" hidden>
            <div class="config-section">
                <div class="config-form-inner dmx-editor">
                    <textarea id="dmx-textarea" placeholder="DMX configuration will load here..."></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Check if OP-Z is configured before allowing access
async function checkDeviceRequirement() {
    try {
        const res = await fetch('/get-config-setting?config_option=OPZ_MOUNT_PATH');
        const data = await res.json();
        const isSet = data.config_value && data.config_value !== '';

        if (!isSet) {
            document.getElementById('device-error-container').hidden = false;
            document.getElementById('main-content').hidden = true;
        }
    } catch (error) {
        console.error('Error checking device configuration:', error);
    }
}
checkDeviceRequirement();
</script>

<script src="/static/js/components/tabs.js"></script>
<script src="/static/js/configeditor.js"></script>

{% endblock %}

</html>